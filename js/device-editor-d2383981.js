this.DeviceEditor=function(){"use strict";var e=function(e,t,s){function i(e){try{return window.sessionStorage.getItem(e)}catch(t){return null}}function r(e,t){try{return window.sessionStorage.setItem(e,t),window.sessionStorage.getItem(e)}catch(s){return null}}this.service=(new SW.Card).services("inventory");var a="<'row'<'table-info-left col-sm-6'fi><'table-info-right col-sm-6'B>><'row'<'table-container col-sm-12't>><'row'<'table-paging col-sm-12'p>>";this.defaultEditorOptions={table:e,idSrc:"id",formOptions:{main:{submit:"changed",drawType:"full-hold"}},i18n:{edit:{title:"<h4>Edit Device(s)</h4>"},multi:{title:"<strong>Multiple values</strong>",info:'"Multiple values" is shown when the devices do not share a common value for the attribute. Click to change all devices at once.'}}},this.defaultTableOptions={pageLength:15,search:{caseInsensitive:!0,regex:!1},searchDelay:500,select:!0,dom:a,language:{search:"Search Devices"}},this.editorOptions=void 0,this.editor=void 0,this.tableOptions=void 0,this.tableColumns=void 0,this.table=void 0,this.progress=void 0,this.adminDefinedColumns=void 0,this.standardColumns=[{name:"name",label:"Name",type:"text",orderable:!0,searchable:!0,visible:!0},{name:"ip_address",label:"IP Address",type:"text",orderable:!0,searchable:!1,visible:!0},{name:"serial_number",label:"Serial Number",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"mac_address",label:"MAC Address",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"asset_tag",label:"Asset Tag",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"device_type",label:"Device Type",type:"text",orderable:!0,searchable:!1,visible:!1},{name:"description",label:"Description",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"manufacturer",label:"Manufacturer",type:"text",orderable:!0,searchable:!0,visible:!0},{name:"model",label:"Model",type:"text",orderable:!0,searchable:!0,visible:!0},{name:"location",label:"Location",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"site",label:"Site",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"owner",label:"Owner",type:"enum",orderable:!1,searchable:!1,visible:!0},{name:"purchase_date",label:"Purchase Date",type:"date",orderable:!1,searchable:!1,visible:!1},{name:"purchase_price",label:"Purchase Price",type:"text",orderable:!1,searchable:!1,visible:!1}],this.users=void 0,this.loadAllUsers=function(e){var t=this;e=_.extend({current_page:0,page_count:1},e);var s=e.current_page+1;return s>e.page_count?(this.users=_.reject(this.users,function(e){return"System Admin"===e.label}),void(this.users=_.sortBy(this.users,"label"))):(this.progress.advance(s),console.log("API load users page="+s),(new SW.Card).services("people").request("people",{page:s,per_page:10}).then(function(e){var s=_.collect(e.people,function(e){var t=e.first_name.concat(" ",e.last_name);return{label:t,value:e.id}});return t.users?t.users=t.users.concat(s):(t.users=s,t.progress.reset({max:e.meta.page_count+2,message:"Loading users"})),e.meta}).then(this.loadAllUsers.bind(this)))},this.initialResponse=void 0,this.loadDeviceMeta=function(){var e=this;return this.progress.say("Loading devices"),this.progress.advance(),this.service.request("devices",{sort:[{name:"asc"}],per_page:this.defaultTableOptions.pageLength}).then(function(t){e.initialResponse=t,e.adminDefinedColumns=t.meta.admin_defined_attrs||[]})},this.version=void 0,this.sorting=!0,this.customAttrs=!0,this.purchaseAttrs=!0,this.loadVersion=function(){var e=this;return this.progress.say("Initializing"),this.progress.advance(),(new SW.Card).services("environment").request("environment").then(function(t){e.version=t.app_host.version,e.sorting=e.version>="7.5.00065",e.customAttrs=e.version>="7.5.00061",e.purchaseAttrs=e.version>="7.5.00061"})},this.errorResponseToString=function n(e){if(_.isArray(e))return _.collect(e,n).join(", ");if(_.isObject(e)&&e.errors)return n(e.errors);var t="";return e.title&&(t=t.concat(e.title,": ")),t=e.details?t.concat(e.details):"string"==typeof e?t.concat(e):t.concat(JSON.stringify(e))},this.editorAjaxAdapter=function(e,t,s,i,r){if("edit"!==s.action)return void r(null,"error","invalid");var a=this,n=_.size(s.data),o=n>1?"Updating devices":"Updating device";this.progress=new Progress({max:n+1,message:o});var l=_.collect(s.data,function(e,t){var s=$.Deferred();return _.isUndefined(e.purchase_price)||(e.c_purchase_price=e.purchase_price),_.isUndefined(e.purchase_date)||(e.c_purchase_date=e.purchase_date),e=_.omit(e,"purchase_price","purchase_date"),console.log("API updates for device "+t+": "+JSON.stringify(e)),a.service.request("device:update",parseInt(t,10),e).then(function(e){a.progress.advance(),s.resolve(e)},function(e){console.warn("API device "+t+" update error: ",a.errorResponseToString(e)),s.reject(e)}),s.promise()});$.when.apply($,l).then(function(e){var t=_.toArray(arguments);i({data:t})},function(e){a.progress.complete();var t=_.collect(_.toArray(arguments),a.errorResponseToString).join(", ");i({error:t})})},this.getEditorField=function(e,t){var s;switch(e.type){case"enum":s="select";break;case"date":s="date";break;default:s="text"}var i=null;"owner"===e.name&&(i=this.users);var r=_.pick(e,"name","label");return _.extend(r,{type:s,data:t,options:i}),this.purchaseAttrs||"purchase_price"!==r.name&&"purchase_date"!==r.name?r:null},this.standardAttributeEditorAccessor=function(e,t,s,i){return"set"!==s?this.standardAttributeTableRenderer(e,t):void 0},this.customAttributeEditorAccessor=function(e,t,s,i){return"set"!==s?this.customAttributeTableRenderer(e,t):void 0},this.getEditorFields=function(){var e=this,t=[];return _.each(this.standardColumns,function(s){t.push(e.getEditorField(s,e.standardAttributeEditorAccessor.bind(e,s)))}),_.each(this.adminDefinedColumns,function(s){t.push(e.getEditorField(s,e.customAttributeEditorAccessor.bind(e,s)))}),_.compact(t)},this.configureEditor=function(){return this.editorOptions=_.extend({},this.defaultEditorOptions,t,{fields:this.getEditorFields(),ajax:this.editorAjaxAdapter.bind(this)}),this.editorOptions},this.onInitEditor=function(){var e=this,t=this.table.rows({selected:!0}).count();t>1?_.each(["name","ip_address","mac_address","serial_number","asset_tag"],function(t){e.editor.hide(t)}):e.editor.show()},this.onEditorOpen=function(e,t,s){("edit"===s||this.table.rows({selected:!0}).count()>1)&&$(".DTE_Form_Content .DTE_Field:not([style*=none]) .multi-value[style*=block]").first().find("[data-dte-e='multi-info']").css("display","block")},this.createEditor=function(e){this.editor=new $.fn.dataTable.Editor(e),this.editor.on("initEdit",this.onInitEditor.bind(this)),this.editor.on("open",this.onEditorOpen.bind(this))},this.standardAttributeTableRenderer=function(e,t,s,i,r){var a=t[e.name]||"";if("site"===e.name)t.site&&t.site.name&&(a=t.site.name);else if("owner"===e.name)t.owner&&t.owner.id?a=t.owner.first_name+" "+t.owner.last_name:t.primary_owner_name&&(a=t.primary_owner_name);else if("date"===e.type&&a.match(/\dT\d/))try{var n=moment(a);a=n.format("YYYY-MM-DD")}catch(o){}return a},this.customAttributeTableRenderer=function(e,t,s,i,r){return t.admin_defined_attrs[e.name]||""},this.getTableColumn=function(e,t){var s;switch(e.type){case"date":s="date";break;default:s="string"}var i=_.pick(e,"name","visible","orderable","searchable");return _.extend(i,{title:e.label,type:s,data:null,render:t}),_.defaults(i,{orderable:!1,searchable:!1,visible:!1}),this.purchaseAttrs||"purchase_price"!==i.name&&"purchase_date"!==i.name?(this.sorting||(i.orderable=!1),i):null},this.getTableColumns=function(){var e=this,t=[];return _.each(this.standardColumns,function(s){t.push(e.getTableColumn(s,e.standardAttributeTableRenderer.bind(e,s)))}),_.each(this.adminDefinedColumns,function(s){t.push(e.getTableColumn(s,e.customAttributeTableRenderer.bind(e,s)))}),this.tableColumns=_.compact(t),this.tableColumns},this.tableAjaxAdapter=function(t,s,i){var r=this,a=1+t.start/this.tableOptions.pageLength,n=function(){r.progress&&!r.progress.isComplete()?(r.progress.say("Loading devices"),r.progress.advance()):$(e+"_wrapper .maskable").addClass("masked")},o=function(){r.progress&&!r.progress.isComplete()?r.progress.complete():$(e+"_wrapper .maskable").removeClass("masked")};n();var l={sort:[{name:"asc"}],page:a,per_page:t.length};if(t.order&&t.order[0]){var d=this.tableOptions.columns[t.order[0].column].name,c=t.order[0].dir,h={};h[d]=c,l.sort[0]=h}t.search&&t.search.value&&(l.search={query:{terms:t.search.value},fields:{names:["name","manufacturer","model"]}}),console.log("API load devices: "+JSON.stringify(l)),this.service.request("devices",l).then(function(e){s({draw:t.draw,data:e.devices,recordsTotal:r.initialResponse.meta.total_entries,recordsFiltered:e.meta.total_entries})},function(e){var i=r.errorResponseToString(e);console.warn("API devices fetch error: ",i),s({draw:t.draw,error:i})}).then(o,o)},this.configureTable=function(){return this.tableOptions=_.extend({},this.defaultTableOptions,s,{columnDefs:[{targets:0,orderable:!1,className:"select-checkbox",data:null,defaultContent:""}],select:{style:"multi",selector:"td:first-child"},order:this.sorting?[[1,"asc"]]:[],columns:[{}].concat(this.getTableColumns()),serverSide:!0,ajax:this.tableAjaxAdapter.bind(this),data:this.initialResponse.devices,deferLoading:[this.initialResponse.meta.total_entries,this.initialResponse.meta.total_entries],buttons:[{extend:"edit",editor:this.editor}]}),this.tableOptions},this.createTable=function(t){$(e).DataTable(t),this.table=$(e).DataTable()},this.onColumnChooserChange=function(e,t){this.table.column(e.attr("name")+":name").visible(t),this.table.columns.adjust()},this.addColumnChooser=function(){var e=$('<div id="column-selector"><select multiple="multiple"></select></div>'),t=e.find("select");_.each(this.tableColumns,function(e){var s=$("<option></option>").attr("name",e.name).text(e.title);e.visible&&s.attr("selected","selected"),s.appendTo(t)}),e.appendTo($(".table-info-right")),$("#column-selector select").multiselect({templates:{button:'<button type="button" class="multiselect dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-cog" aria-hidden="true"></span> Columns</button>',ul:'<ul class="multiselect-container dropdown-menu dropdown-menu-right"></ul>'},onChange:this.onColumnChooserChange.bind(this)})},this.addMasks=function(){$(".table-info-left .dataTables_info").addClass("maskable"),$(".table-info-right .btn-group").addClass("maskable"),$(".table-container").addClass("maskable"),$(".table-paging .dataTables_paginate").addClass("maskable")},this.displayUpgrade=function(){var t=this,s="dismissed-spiceworks-upgrade";if(!i(s)){var a=!0;if(a=a&&this.sorting,a=a&&this.customAttrs,a=a&&this.purchaseAttrs,!a){var n=[];this.sorting||n.push("sorting by columns"),this.customAttrs||n.push("editing of custom attributes"),this.purchaseAttrs||n.push("editing purchase price and date"),n=n.join(", ").replace(/,\s([^,]+)$/," and $1"),$(e+"_wrapper").prepend(JST["templates/upgrade"]({features:n})),$("#upgrade-spiceworks-message").on("closed.bs.alert",function(){r(s,t.version)})}}},this.load=function(){return this.progress=new Progress({message:"Loading users"}),this.loadAllUsers.call(this).then(this.loadDeviceMeta.bind(this)).then(this.loadVersion.bind(this)).then(this.configureEditor.bind(this)).then(this.createEditor.bind(this)).then(this.configureTable.bind(this)).then(this.createTable.bind(this)).then(this.addColumnChooser.bind(this)).then(this.addMasks.bind(this)).then(this.displayUpgrade.bind(this)).then(null,console.error.bind(console)).then(this.progress.complete.bind(this.progress),this.progress.complete.bind(this.progress))}};return e}();