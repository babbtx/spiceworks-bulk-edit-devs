this.DeviceEditor=function(){"use strict";var e=function(){this.service=(new SW.Card).services("inventory");var e="<'row'<'editor-search col-sm-6'fi><'editor-actions col-sm-6'B>><'row'<'col-sm-12'rt>><'row'<'editor-paging col-sm-12'p>>";this.defaultEditorOptions={idSrc:"id",formOptions:{main:{submit:"changed",drawType:"full-hold",title:"Edit Device(s)"}}},this.defaultTableOptions={pageLength:15,search:{caseInsensitive:!0,regex:!1},searchDelay:500,select:!0,dom:e},this.editorOptions=void 0,this.tableOptions=void 0,this.editor=void 0,this.adminDefinedColumns=void 0,this.standardColumns=[{name:"name",label:"Name",type:"text",orderable:!0,searchable:!0,visible:!0},{name:"ip_address",label:"IP Address",type:"text",orderable:!0,searchable:!1,visible:!0},{name:"serial_number",label:"Serial Number",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"mac_address",label:"MAC Address",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"asset_tag",label:"Asset Tag",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"device_type",label:"Device Type",type:"text",orderable:!0,searchable:!1,visible:!1},{name:"description",label:"Description",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"manufacturer",label:"Manufacturer",type:"text",orderable:!0,searchable:!0,visible:!0},{name:"model",label:"Model",type:"text",orderable:!0,searchable:!0,visible:!0},{name:"location",label:"Location",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"site",label:"Site",type:"text",orderable:!1,searchable:!1,visible:!1},{name:"owner",label:"Owner",type:"enum",orderable:!1,searchable:!1,visible:!0},{name:"purchase_date",label:"Purchase Date",type:"date",orderable:!1,searchable:!1,visible:!1},{name:"purchase_price",label:"Purchase Price",type:"text",orderable:!1,searchable:!1,visible:!1}],this.users=void 0,this.loadAllUsers=function(e){e=_.extend({current_page:0,page_count:1},e);var t=e.current_page+1;if(t>e.page_count)return this.users=_.reject(this.users,function(e){return"System Admin"===e.label}),void(this.users=_.sortBy(this.users,"label"));console.log("API load users page="+t);var r=this;return(new SW.Card).services("people").request("people",{page:t,per_page:5}).then(function(e){var t=_.collect(e.people,function(e){var t=e.first_name.concat(" ",e.last_name);return{label:t,value:e.id}});return r.users=(r.users||[]).concat(t),e.meta}).then(this.loadAllUsers.bind(this))},this.initialResponse=void 0,this.loadDeviceMeta=function(){var e=this;return this.service.request("devices",{sort:[{name:"asc"}],per_page:this.defaultTableOptions.pageLength}).then(function(t){e.initialResponse=t,e.adminDefinedColumns=t.meta.admin_defined_attrs||[]})},this.errorResponseToString=function t(e){if(_.isArray(e))return _.collect(e,t).join(", ");if(_.isObject(e)&&e.errors)return t(e.errors);var r="";return e.title&&(r=r.concat(e.title,": ")),r=e.details?r.concat(e.details):"string"==typeof e?r.concat(e):r.concat(JSON.stringify(e))},this.editorAjaxAdapter=function(e,t,r,i,a){if("edit"!==r.action)return void a(null,"error","invalid");var s=this,n=_.collect(r.data,function(e,t){var r=$.Deferred();return console.log("API updates for device "+t+": "+JSON.stringify(e)),s.service.request("device:update",parseInt(t,10),e).then(function(e){r.resolve(e)},function(e){console.warn("API device "+t+" update error: ",s.errorResponseToString(e)),r.reject(e)}),r.promise()});$.when.apply($,n).then(function(e){var t=_.toArray(arguments);i({data:t})},function(e){var t=_.collect(_.toArray(arguments),s.errorResponseToString).join(", ");i({error:t})})},this.getEditorField=function(e,t){var r;switch(e.type){case"enum":r="select";break;case"date":r="date";break;default:r="text"}var i=null;"owner"===e.name&&(i=this.users);var a=_.pick(e,"name","label");return _.extend(a,{type:r,data:t,options:i}),a},this.standardAttributeEditorAccessor=function(e,t,r,i){return"set"!==r?this.standardAttributeTableRenderer(e,t):void 0},this.customAttributeEditorAccessor=function(e,t,r,i){return"set"!==r?this.customAttributeTableRenderer(e,t):void 0},this.getEditorFields=function(){var e=this,t=[];return _.each(this.standardColumns,function(r){t.push(e.getEditorField(r,e.standardAttributeEditorAccessor.bind(e,r)))}),_.each(this.adminDefinedColumns,function(r){t.push(e.getEditorField(r,e.customAttributeEditorAccessor.bind(e,r)))}),t},this.configureEditor=function(e,t){return this.editorOptions=_.extend({},this.defaultEditorOptions,{table:e,fields:this.getEditorFields()},t,{ajax:this.editorAjaxAdapter.bind(this)}),this.editorOptions},this.createEditor=function(e){this.editor=new $.fn.dataTable.Editor(e)},this.standardAttributeTableRenderer=function(e,t,r,i,a){var s=t[e.name]||"";return"site"===e.name?t.site&&t.site.name&&(s=t.site.name):"owner"===e.name&&(t.owner&&t.owner.id?s=t.owner.first_name+" "+t.owner.last_name:t.primary_owner_name&&(s=t.primary_owner_name)),s},this.customAttributeTableRenderer=function(e,t,r,i,a){return t.admin_defined_attrs[e.name]||""},this.getTableColumn=function(e,t){var r;switch(e.type){case"date":r="date";break;default:r="string"}var i=_.pick(e,"name","visible","orderable","searchable");return _.extend(i,{title:e.label,type:r,data:null,render:t}),_.defaults(i,{orderable:!1,searchable:!1,visible:!1}),i},this.getTableColumns=function(){var e=this,t=[];return _.each(this.standardColumns,function(r){t.push(e.getTableColumn(r,e.standardAttributeTableRenderer.bind(e,r)))}),_.each(this.adminDefinedColumns,function(r){t.push(e.getTableColumn(r,e.customAttributeTableRenderer.bind(e,r)))}),t},this.tableAjaxAdapter=function(e,t,r){var i=this,a=1+e.start/this.tableOptions.pageLength,s={sort:[{name:"asc"}],page:a,per_page:e.length};if(e.order&&e.order[0]){var n=this.tableOptions.columns[e.order[0].column].name,o=e.order[0].dir,l={};l[n]=o,s.sort[0]=l}e.search&&e.search.value&&(s.search={query:{terms:e.search.value},fields:{names:["name","manufacturer","model"]}}),console.log("API load devices: "+JSON.stringify(s)),this.service.request("devices",s).then(function(r){t({draw:e.draw,data:r.devices,recordsTotal:i.initialResponse.meta.total_entries,recordsFiltered:r.meta.total_entries})},function(r){var a=i.errorResponseToString(r);console.warn("API devices fetch error: ",a),t({draw:e.draw,error:a})})},this.configureTable=function(e){return this.tableOptions=_.extend({},this.defaultTableOptions,e,{columnDefs:[{targets:0,orderable:!1,className:"select-checkbox",data:null,defaultContent:""}],select:{style:"multi",selector:"td:first-child"},order:[[1,"asc"]],columns:[{}].concat(this.getTableColumns()),serverSide:!0,ajax:this.tableAjaxAdapter.bind(this),data:this.initialResponse.devices,deferLoading:[this.initialResponse.meta.total_entries,this.initialResponse.meta.total_entries],buttons:[{extend:"edit",editor:this.editor}]}),this.tableOptions},this.createTable=function(e,t){$(e).DataTable(t)},this.load=function(e,t,r){return this.loadAllUsers.call(this).then(this.loadDeviceMeta.bind(this)).then(this.configureEditor.bind(this,e,t)).then(this.createEditor.bind(this)).then(this.configureTable.bind(this,r)).then(this.createTable.bind(this,e))}};return e}();